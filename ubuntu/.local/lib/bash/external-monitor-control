#!/bin/bash -ue

source ~/.config/hardware/external-displayrc
rc="$HOME/.config/hardware/external-displayrc"

# Flick reading mode if command is to swap mode
if [ $1 = "bs" ]; then
    if [ $is_reading_mode = true ]; then
		is_reading_mode=false
    else
		is_reading_mode=true
    fi
fi

# Set mode/brightness/temperature based on reading/video mode
if [ $is_reading_mode = true ]; then
    mode="reading"
    brightness=$reading_brightness
    temperature=$color_temperature_reading
else
    mode="video"
    brightness=$video_brightness
    temperature=$color_temperature_video
fi

case "$1" in
    b)
        # When booting up, reading DDC information may fail sometimes on NVIDIA cards.
        # TODO: Add retry limit
        while true; do
            output=`ddcutil getvcp $brightness_feature_id --bus $i2c_bus | gawk '{print $9}' | sed 's/,//' | tail -1`
            if [[ $output == ?(-)+([0-9]) ]]; then
                echo $output
                exit 0
            fi
            sleep 2
        done
        ;;
    bu)
        let brightness="$brightness + $brightness_step"
        if [ $brightness -gt 100 ]; then
            brightness=100
        fi
		ddcutil setvcp $brightness_feature_id $brightness --bus $i2c_bus
        sed -i s/"$mode"_brightness=.*/"$mode"_brightness=$brightness/ $rc
        echo $brightness
        ;;
    bd)
        let brightness="$brightness - $brightness_step"
        if [ $brightness -lt 0 ]; then
            brightness=0
        fi
		ddcutil setvcp $brightness_feature_id $brightness --bus $i2c_bus
        sed -i s/"$mode"_brightness=.*/"$mode"_brightness=$brightness/ $rc
        echo $brightness
        ;;
    bs)
        if [ $mode = "reading" ]; then
            isReadingMode="true"
        else
            isReadingMode="false"
        fi
		ddcutil setvcp $brightness_feature_id $brightness --bus $i2c_bus
		ddcutil setvcp $color_temperature_feature_id $temperature --bus $i2c_bus
        sed -i s/is_reading_mode=.*/is_reading_mode="$isReadingMode"/ $rc
        echo $brightness
        ;;
esac
