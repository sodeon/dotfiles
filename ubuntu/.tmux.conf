# Reload tmux config: <C-e>r
#----------------------------------------------------------------------------------------------------------------------
# Keyboard/mouse control configuration
#----------------------------------------------------------------------------------------------------------------------
set -g default-terminal 'xterm-256color'
# set -g default-terminal 'screen-256color'

# Use ctrl-e as activation key
unbind C-b
set -g prefix C-e

# Enable ctrl-left/right to move cursor across word
set -g xterm-keys on

# Send focus event to app. E.g. VIM uses focus event to determine if a file has changed
set -g focus-events on

# When pane has update, highlight in status line
set -g monitor-activity on

# Use status line pane title for terminal title
# set -g set-titles on
# set -g set-titles-string "#I:#W"

# Vim-like copy mode ([)
setw -g mode-keys vi
bind-key -Tcopy-mode-vi 'v' send -X begin-selection
bind-key -Tcopy-mode-vi 'y' send -X copy-selection-and-cancel
bind-key -Tcopy-mode-vi 'C-v' send -X rectangle-toggle
bind-key -Tcopy-mode-vi 'Escape' send -X cancel
# bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle \; send -X begin-selection # compatible from 2.4
bind p paste-buffer

# Vim-like pane switching
# bind -r h select-pane -L
# bind -r j select-pane -D
# bind -r k select-pane -U
# bind -r l select-pane -R
# bind C-e  select-pane -t :.+ # go to next pane

# Vim, fzf unified pane navigation
# https://www.bugsnag.com/blog/tmux-and-vim
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
# is_fzf="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?fzf$'"
# bind -n M-h run "($is_vim && tmux send-keys M-h) ||                                    tmux select-pane -L"
# bind -n M-j run "($is_vim && tmux send-keys M-j) || ($is_fzf && tmux send-keys C-j) || tmux select-pane -D"
# bind -n M-k run "($is_vim && tmux send-keys M-k) || ($is_fzf && tmux send-keys C-k) || tmux select-pane -U"
# bind -n M-l run "($is_vim && tmux send-keys M-l) ||                                    tmux select-pane -R"
bind -n M-h run "($is_vim && tmux send-keys M-h) || tmux select-pane -L"
bind -n M-j run "($is_vim && tmux send-keys M-j) || tmux select-pane -D"
bind -n M-k run "($is_vim && tmux send-keys M-k) || tmux select-pane -U"
bind -n M-l run "($is_vim && tmux send-keys M-l) || tmux select-pane -R"
# i3, tmux and vim integration
bind -n M-C-y run "($is_vim && tmux send-keys M-C-y) || vim-tmux-i3-integration focus left"
bind -n M-C-u run "($is_vim && tmux send-keys M-C-u) || vim-tmux-i3-integration focus down"
bind -n M-C-i run "($is_vim && tmux send-keys M-C-i) || vim-tmux-i3-integration focus up"
bind -n M-C-o run "($is_vim && tmux send-keys M-C-o) || vim-tmux-i3-integration focus right"

# Vim-like pane splitting
bind -r v   split-window -h -c "#{pane_current_path}" # vertical split, "vs" in vim
bind -r s   split-window    -c "#{pane_current_path}" # horizontal split, "sp" in vim
# bind -r | resize-pane -Z  # maximize
bind -r = select-layout even-horizontal # restore maximized
# note: you can use <C-o> rotate pane

# Tab switching
bind -r t   new-window -c "#{pane_current_path}"
bind -n M-q previous-window
bind -n M-w next-window
bind -n M-e run "(tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys q) || tmux kill-pane"
bind -n M-Q swap-window -t -1
bind -n M-W swap-window -t +1

# page up is "page up". No prefix or anything required. Caveat: pageup cannot be used in other programs
bind -n Pageup copy-mode -ue # Pageup goes to copy mode directly, -e means when scrolled down to bottom, exit copy mode

# start window numbers at 1 to match keyboard order with tmux window order
set  -g base-index 1
setw -g pane-base-index 1
# renumber windows sequentially after closing any of them
set -g renumber-windows on

# Rename window
bind -r A command-prompt -I "#W" "rename-window %%"

# Reload tmux config
bind r source-file ~/.tmux.conf \; display ".tmux.conf loaded"

# Mouse/keyboard
set -g -q mouse on
set -sg escape-time 0 # tmux will delay escape key registration for 500ms. This remove that.


#----------------------------------------------------------------------------------------------------------------------
# App compatibility config
#----------------------------------------------------------------------------------------------------------------------
# If inside vim, allow tab switching
bind -n C-Pageup   run "tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys gT"
# For whatever reason, C-Pageup cannot be passed to vim
bind -n C-Pagedown run "tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys gt"


#----------------------------------------------------------------------------------------------------------------------
# Looks
#----------------------------------------------------------------------------------------------------------------------
set -g status-interval 1 # update status every 1s
set -g allow-rename on
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}(#{pane_current_command})'
# set -g automatic-rename-format '#T'

set -g status-justify centre

# remove administrative debris (session name, hostname, time) in status bar
set -g status-left ''
set -g status-right ''

# set -g status-right "#[fg=colour010]#(cmus-remote -Q | grep file | sed 's/^file.*\\///' | sed 's/\\.\\(mp3\\|aac\\|wma\\|flac\\)$//')  #[fg=colour123] #(date '+%d   %H:%M #[default]')"
# set -g status-right "#[fg=colour010]#(cmus-remote -Q | grep file | sed 's/^file.*\\///' | sed 's/\\.\\(mp3\\|aac\\|wma\\|flac\\)$//')  #[fg=colour136] #($TMUX_PLUGIN_MANAGER_PATH/tmux-mem-cpu-load/tmux-mem-cpu-load -g 0 -m 1 -a 0 --interval 2)   #[fg=colour123] #(date '+%d   %H:%M #[default]')"

set -g window-status-format '#W '
set -g window-status-current-format '#[fg=colour252,bg=colour0]#W '
set -g window-status-separator ' '

set -g status-position top

set -g status-bg black
set -g status-fg colour240

# set -g pane-border-fg colour235
# set -g pane-active-border-fg colour240
set -g pane-border-fg black
set -g pane-active-border-fg black

# Hide status bar when there is only one tab
if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"
set-hook -g window-linked   'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
set-hook -g window-unlinked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'


#----------------------------------------------------------------------------------------------------------------------
# Plugins and its settings
#----------------------------------------------------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-dir '~/.tmux-resurrect'
# set -g @resurrect-save 'C-t'

set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-boot    'off'     # do not run tmux when computer boots
set -g @continuum-restore 'off'     # restore tmux when opening terminal
set -g @continuum-save-interval '0' # do not save settings

# set -g @plugin 'jbnicolai/tmux-fpp'
# set -g @fpp-key 'f'
set -g @plugin 'Morantron/tmux-fingers'
set -g @fingers-key y # yank

# set -g @plugin 'thewtex/tmux-mem-cpu-load'
# set -g status-right-length 120

#set -g @plugin 'tmux-plugins/tmux-cpu' # does not use cpu utilization as Windows takes 2s to get one reading and consume a lot of CPU resources
#set -g @cpu_low_fg_color    "#[fg=colour240]"
#set -g @cpu_medium_fg_color "#[fg=colour130]"
#set -g @cpu_high_fg_color   "#[fg=colour196]"

#set -g @plugin 'GROG/tmux-plugin-mem'
#set -g @mem_high_color      "#[fg=colour196]" # red
#set -g @mem_mid_color       "#[fg=colour178]" # light yellow
#set -g @mem_low_color       "#[fg=colour240]"
#set -g @mem_high_percentage "75" # default 75%
#set -g @mem_mid_percentage "60"

#source-file "${HOME}/.tmux/tmux-themepack/powerline/block/gray.tmuxtheme"

# Keep this line at the very bottom of .tmux.conf
run '~/.tmux/plugins/tpm/tpm'
