#!/bin/bash -ue
#------------------------------------------------------------------------------
# Helpers
#------------------------------------------------------------------------------
isActiveWinFloating() {
    xprop -id $(xdotool getactivewindow) | grep -q "WM_STATE.*STICKY"
}

isWorkspaceEmpty() {
    ! xdotool getactivewindow
}

try-focus-non-floating() {
    if isActiveWinFloating; then
        i3-msg "focus mode_toggle" || true # If there is only floating window, "focus mode_toggle" won't do anything
    fi
}


#------------------------------------------------------------------------------
# Window event handlers
#------------------------------------------------------------------------------
win-close-handler() {
    # If workspace is empty or only floating remaining, go back to previous workspace (for file manager and viewer)
    # If previous workspace is also empty, go to default (terminal) workspace
    # NOTE: This behavior is designed for only one floating window in use
    try-focus-non-floating # Floating window always get last priority for input focus
    if isWorkspaceEmpty || isActiveWinFloating; then # Check if workspace is empty
        i3-msg "workspace back_and_forth"
        try-focus-non-floating # Again, try to focus non-floating window after switching workspace.
        if isWorkspaceEmpty || isActiveWinFloating; then # Check if workspace is empty
            i3-msg "workspace number 2"
            try-focus-non-floating # Again, try to focus non-floating window after switching workspace.
        fi
    fi
}

win-enter-fullscreen-handler() {
    :
}


#------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------
i3-msg -t subscribe -m '[ "window" ]' | \
while read -r event; do 
    # Update window title on i3blocks
    pkill -RTMIN+13 i3blocks

    if echo $event | grep -q '^{"change":"close",'; then
        win-close-handler
    fi

    # if echo $event | grep -q '^{"change":"fullscreen_mode",'; then
    #     if echo $event | grep -q ',"fullscreen_mode":1,'; then
    #         win-enter-fullscreen-handler
    #     fi
    # fi
done
