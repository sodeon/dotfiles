#!/bin/bash -ue
. log.sh

GRUB_DEFAULT=saved
GRUB_TIMEOUT=5

if grep -q ^\s*GRUB_DISABLE_OS_PROBER\s*=\s*false /etc/default/grub; then
    warn "Disabling GRUB boot menu ..."
    sudo sed -i -re 's/^(\s*GRUB_TIMEOUT\s*=\s*)"?[0-9]+"?/\10/' /etc/default/grub
    sudo sed -i -re 's/^(\s*GRUB_DISABLE_OS_PROBER\s*=\s*)false/\1true/' /etc/default/grub
    sudo sed -i -re 's/^(\s*GRUB_TERMINAL\s*=\s*.*)/# \1/' /etc/default/grub
    sudo update-grub
    # warn "Warning: GRUB only allows disabling grub menu when last booting to linux."
else
    warn "Enabling GRUB boot menu ..."
    sudo sed -i -re 's/^(\s*GRUB_TIMEOUT\s*=\s*)"?[0-9]+"?/\1'$GRUB_TIMEOUT'/' /etc/default/grub
    sudo sed -i -re 's/^(\s*GRUB_DISABLE_OS_PROBER\s*=\s*)true/\1false/' /etc/default/grub
    sudo sed -i -re 's/^#\s*(GRUB_TERMINAL\s*=\s*.*)/\1/' /etc/default/grub
    sudo update-grub
fi
