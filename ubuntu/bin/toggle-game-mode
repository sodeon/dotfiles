#!/bin/bash -u
cmd=${1-""}
screenBlankTime=600

# Game mode:
# 1. Disable compositor to improve display latency.
# 2. Disable fractional scaling in X11 which has a larger internal resolution.
# 3. Overclock GPU (currently done at boot time).
# 4. Disable keyboard macros to improve latency and reduce context switches.

start-game-mode() {
    # export __GL_SHADER_DISK_CACHE_PATH="/mnt/d/wine/gl-cache/$game_name" # exported variables will not be passed to games
    # export VKD3D_SHADER_CACHE_PATH=/mnt/d/wine/dxvk-cache # has no effect
    case ${__GL_SHADER_DISK_CACHE_PATH-""} in
        "")
            ;;
        "/mnt/d/wine/gl-cache/")
            notify-send.sh -u critical "Env Not Customized" "__GL_SHADER_DISK_CACHE_PATH"
            ;;
        *)
            mkdir -p "$__GL_SHADER_DISK_CACHE_PATH"
            ;;
    esac

    game_refresh_rate=${game_refresh_rate-"$refresh_rate"}
    # toggle-nvidia-oc on & > /dev/null
    kill-compositor
    xrandr --output $interface --mode $resolution --scale 1x1    --rate $game_refresh_rate # Disable fractional scaling and return to native display resolution
    disable-screen-blanking # xset s 0 0 && xset dpms 0 0 0
    activate-hotkeys game-mode &
    # setup-mouse      game-mode &
    notify-send.sh -t 5000 -r 19 "Game Mode" "Enabled"
}

stop-game-mode() {
    # setup-mouse      &
    activate-hotkeys &
    xrandr --output $interface --mode $resolution --scale $scale --rate $refresh_rate
    xset s $screenBlankTime $screenBlankTime && xset dpms $screenBlankTime $screenBlankTime $screenBlankTime
    start-compositor
    # toggle-nvidia-oc off & > /dev/null
    notify-send.sh -t 5000 -r 19 "Game Mode" "Disabled"
}


source source-display-monitor
if $is_game_mode; then
    if [[ $cmd == "on" ]]; then
        start-game-mode
    else
        monitor-control bg >/dev/null && (pkill -RTMIN+11 i3blocks &)
        stop-game-mode
    fi
else
    if [[ $cmd == "off" ]]; then
        stop-game-mode
    else
        monitor-control bg >/dev/null && (pkill -RTMIN+11 i3blocks &)
        start-game-mode
    fi
fi

