#!/bin/bash

shortcut=$1
pid=
windowId=


#-----------------------------------------------------------------------------------------------
# Support library
#-----------------------------------------------------------------------------------------------
activeWinId() {
    # cache active window id result
    if [ -z $windowId ]; then
        windowId=`xdotool getwindowfocus`
    fi
    result=$?
    echo $windowId
    return $result
}

activeWinPid() {
    # cache active window pid result
    if [ -z $pid ]; then
        pid=`xdotool getwindowfocus getwindowpid`
    fi
    result=$?
    echo $pid
    return $result
}

# @param class name
isWinActive() {
    activeWinPid | xargs -i xdotool search --all --pid {} --class $1
    return $?
}

isActiveWinTitle() {
    title=`xdotool getactivewindow getwindowname`
    if echo $title | grep -E $1; then
        return 0
    else
        return 1
    fi
}

# @param class name
isWinExists() {
    xdotool search --class $1
    return $?
}

# i3 and VIM navigation integration
focusWindow() {
    direction=$1
	case $direction in
		left)
			navKey=h
			;;
		right)
			navKey=l
			;;
		up)
			navKey=k
			;;
		down)
			navKey=j
			;;
	esac
    if isActiveWinTitle VIM$; then
        xdotool keyup $navKey keyup alt key Escape key ctrl+$navKey keydown alt
    elif isWinActive Code; then
        if [[ $direction == left || $direction == right ]]; then
			xdotool keyup $navKey keyup alt key Escape key ctrl+$navKey keydown alt
		else
			i3-msg "focus $direction"
		fi
    else
		i3-msg "focus $direction"
    fi
}


#-----------------------------------------------------------------------------------------------
# Shortcut implementation
#-----------------------------------------------------------------------------------------------
deleteWord() {
	if isWinActive URxvt; then
		xdotool keyup p keyup control key ctrl+w
	else
		xdotool keyup p key ctrl+BackSpace
	fi
}

closeTabOrWindow() {
    if isWinActive Google-chrome || isWinActive Firefox; then
        xte 'keydown Control_L' 'key w' 'keyup Control_L'
    else
        xte 'keydown Alt_L' 'key grave' 'keyup Alt_L'
    fi
}

toggleFloating() {
    # When mpv got focused (mpv always floating), go to full screen
    if isWinActive mpv; then
        i3-msg fullscreen
    fi
}

pageup() {
    if isWinActive URxvt && ! isActiveWinTitle VIM$; then
		xdotool keyup b key --clearmodifiers shift+Prior
    else
        xdotool keyup b key --clearmodifiers Prior
    fi
}

pagedown() {
    if isWinActive URxvt && ! isActiveWinTitle VIM$; then
		xdotool keyup f key --clearmodifiers shift+Next
    else
        xdotool keyup f key --clearmodifiers Next
    fi
}

pause() {
    if isWinExists mpv; then
		echo cycle pause | socat - ~/.config/mpv/socket
    else
		cmus-remote -u && pkill -RTMIN+12 i3blocks
    fi
}

nextTrack() {
    if isWinExists mpv; then
		echo playlist-next | socat - ~/.config/mpv/socket
    else
		cmus-remote -n && pkill -RTMIN+12 i3blocks
    fi
}

prevTrack() {
    if isWinExists mpv; then
		echo playlist-prev | socat - ~/.config/mpv/socket
    else
		cmus-remote -r && pkill -RTMIN+12 i3blocks
    fi
}


#-----------------------------------------------------------------------------------------------
# Shortcut assignments
#-----------------------------------------------------------------------------------------------
case $shortcut in
    Mod3+p)
        deleteWord
        ;;
    mod+space)
        toggleFloating
        ;;
    ctrl+b)
        pageup
        ;;
    ctrl+f)
        pagedown
        ;;
    mod+h)
        focusWindow left
        ;;
    mod+j)
        focusWindow down
        ;;
    mod+k)
        focusWindow up
        ;;
    mod+l)
        focusWindow right
        ;;
    Mod3+Shift+k)
        pause
        ;;
    Mod3+Shift+j)
        prevTrack
        ;;
    Mod3+Shift+l)
        nextTrack
        ;;

    # Mouse
    b:8)
        closeTabOrWindow
        ;;
esac
