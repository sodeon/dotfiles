#!/bin/bash -ue

inputs=`xinput --list --short`

activate-hotkeys() {
    # Kill residual xcape/xbindkeys processes
    pgrep xbindkeys > /dev/null && pkill xbindkeys
    pgrep xcape     > /dev/null && pkill xcape

    # Modifiers and mode_switch layer
    xmodmap ~/.Xmodmap

    # Dual-purpose modifiers
    # Caps lock   : Esc
    # Left alt    : alt+tab
    # Left ctrl   : ctrl+z
    # Left Windows: app launcher
    # Right alt   : volume down
    # Right ctrl  : volume up
    # Right shift : Windows+space (toggle input method)
    xcapeTyping="Control_L=Escape;Control_R=Super_L|space;Super_R=Super_L|space"
    xcapeLauncher="Super_L=Super_L|F12;Mode_switch=Control_L|z"
    xcapeVolume="Alt_R=XF86AudioLowerVolume;Super_R=XF86AudioRaiseVolume;Control_R=XF86AudioRaiseVolume"
    xcapeAppSwitcher="Alt_L=Alt_L|Tab"
    if [[ $XDG_CURRENT_DESKTOP == "i3" ]]; then
        xcape -t 160 -e "$xcapeTyping;$xcapeAppSwitcher;$xcapeLauncher"
    else
        xcape -t 160 -e "$xcapeTyping;$xcapeAppSwitcher"
    fi

    # Keyboard keybindings
    cat ~/.config/xbindkeys/keyboard >  /tmp/xbindkeysrc
    echo "$inputs" | grep -q "Designer Keyboard" && cat ~/.config/xbindkeys/microsoft-designer-keyboard >> /tmp/xbindkeysrc

    # Mouse keybindings
    echo "$inputs" | grep -q "M720.*pointer"            && cat ~/.config/xbindkeys/logitech-m720  >> /tmp/xbindkeysrc
    echo "$inputs" | grep -q "Razer Basilisk.*pointer"  && cat ~/.config/xbindkeys/razer-basilisk >> /tmp/xbindkeysrc
    
    xbindkeys -f /tmp/xbindkeysrc
}

setup-mouse-scroll-speed() {
    if echo "$inputs" | grep -q \
       -e "M720.*pointer" \
       -e "Razer.*pointer"; then
        pgrep imwheel > /dev/null && pkill imwheel
        imwheel -b "4 5" > /dev/null 2>&1 # Restrict imwheel to only affect scroll wheel. If unrestricted, thumb buttons will not work anymore
    fi
}


# 
# Main
#
activate-hotkeys
setup-mouse-scroll-speed
