#!/bin/bash -ue

inputs=`xinput --list --short`

activate-hotkeys() {
    # Kill residual xcape/xbindkeys processes
    pgrep xbindkeys > /dev/null && pkill xbindkeys
    pgrep xcape     > /dev/null && pkill xcape

    # Modifiers and mode_switch layer
    xmodmap ~/.Xmodmap

    # Dual-purpose modifiers
    # Caps lock   : Esc
    # Left alt    : alt+tab
    # Left ctrl   : ctrl+z
    # Left Windows: app launcher
    # Right alt   : Windows+space (toggle input method)
    xcapeTyping="Control_L=Escape;Alt_R=Super_L|space"
    xcapeLauncher="Super_L=Super_L|F12"
    xcapeAppSwitcher="Alt_L=Alt_L|Tab;Mode_switch=Control_L|z"
    xcapeMouse="Hyper_L=XF86Launch7"
    if [[ $XDG_CURRENT_DESKTOP == "i3" ]]; then
        xcape -e "$xcapeTyping;$xcapeAppSwitcher;$xcapeMouse;$xcapeLauncher"
    else
        xcape -e "$xcapeTyping;$xcapeAppSwitcher;$xcapeMouse"
    fi

    # Keyboard keybindings
    cat ~/.config/xbindkeys/keyboard >  /tmp/xbindkeysrc
    echo "$inputs" | grep -q "Designer Keyboard" && cat ~/.config/xbindkeys/microsoft-designer-keyboard >> /tmp/xbindkeysrc

    # Mouse keybindings
    echo "$inputs" | grep -q "Razer Basilisk.*pointer" && \
        ([ -f /tmp/mouse-alt ] && cat ~/.config/xbindkeys/razer-basilisk-alt >> /tmp/xbindkeysrc || cat ~/.config/xbindkeys/razer-basilisk >> /tmp/xbindkeysrc)
    
    xbindkeys -f /tmp/xbindkeysrc
}

setup-mouse-scroll-speed() {
    pgrep imwheel > /dev/null && pkill imwheel
    if echo "$inputs" | grep -q \
       -e "Razer.*pointer"; then
        imwheel -b "4 5" > /dev/null 2>&1 # Restrict imwheel to only affect scroll wheel. If unrestricted, thumb buttons will not work anymore
    fi
}


# 
# Main
#
# [ ! -f /tmp/mouse-alt ] && setup-mouse-scroll-speed # When xbindkeys binds mouse buttons, imwheel won't work. Also vice versa.
activate-hotkeys
