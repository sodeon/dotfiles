#!/bin/bash -ue
# Reference: 
# https://tonisagrista.com/blog/2020/droidcam-setup/
# https://serverfault.com/questions/188936/writing-to-stdin-of-background-process

# Reload webcam kernel module
# pgrep mpv && pkill mpv
sudo modprobe -r v4l2loopback-dc # Remove module
sudo modprobe    v4l2loopback-dc width=1440 height=1920 # Insert module

# Open MPV
# mpv config: https://github.com/Kyuunex/better_droidcam_linux_client
$(mpv av://v4l2:/dev/video0 --no-cache --untimed --no-demuxer-thread --no-terminal; pkill droidcam-cli) &  # --video-sync=audio --vd-lavc-threads=1

# Start droidcam-cli (https://www.dev47apps.com/droidcam/linux/)
sleep 0.1 # Wait a little delay for module to fully loaded. If not, /dev/video0 may be be able to use in time.
pipe=/tmp/droidcam-pipe
rm -f $pipe && mkfifo $pipe # make fifo
tail -f $pipe | droidcam-cli 192.168.0.110 4747 & # start server and read from fifo
echo "+" > $pipe &
sleep 0.3; echo "+" > $pipe & # Wait a little delay for droidcam to consume the command or the command may be dropped
sleep 0.3; echo "a" > $pipe &

# stdin of the last command of last command (PID: $!)
# stdin=/proc/$!/fd/0
