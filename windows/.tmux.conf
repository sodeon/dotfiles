#----------------------------------------------------------------------------------------------------------------------
# Keyboard/mouse control configuration
#----------------------------------------------------------------------------------------------------------------------
# Use ctrl-e as activation key
unbind C-b
set -g prefix C-e

# Enable ctrl-left/right to move cursor across word
set-window-option -g xterm-keys on

# Send focus event to app. E.g. VIM uses focus event to determine if a file has changed
set -g focus-events on

# Vim-like copy mode
setw -g mode-keys vi
bind -t vi-copy v      begin-selection
bind -t vi-copy y      copy-selection
bind -t vi-copy C-v    rectangle-toggle
bind -t vi-copy Escape cancel
# bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle \; send -X begin-selection # compatible from 2.4
bind p paste-buffer

# Vim-like pane switching
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R
bind C-e  select-pane -t :.+ # go to next pane

# Vim-like pane splitting
bind -r v split-window -h # vertical split, "vs" in vim
bind -r s split-window    # horizontal split, "sp" in vim
bind -r | resize-pane -Z  # maximize
bind -r = select-layout even-horizontal # restore maximized
# note: you can use <C-o> rotate pane

# VSCode-like tab switching
bind -n C-t new-window
bind -n M-q previous-window
bind -n M-w next-window
bind -n M-e run "(tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys q) || tmux kill-pane"
bind -n M-Q swap-window -t -1
bind -n M-W swap-window -t +1

# page up is "page up". No prefix or anything required. Caveat: pageup cannot be used in other programs
bind -n Pageup   copy-mode -ue # Pageup goes to copy mode directly, -e means when scrolled down to bottom, exit copy mode

# start window numbers at 1 to match keyboard order with tmux window order
# set  -g base-index 1
# setw -g pane-base-index 1
# renumber windows sequentially after closing any of them
# set -g renumber-windows on

# Reload tmux config
bind r source-file ~/.tmux.conf \; display ".tmux.conf loaded"

# Mouse/keyboard
set -g -q mouse on
set -sg escape-time 0 # tmux will delay escape key registration for 500ms. This remove that.


#----------------------------------------------------------------------------------------------------------------------
# App compatibility config
#----------------------------------------------------------------------------------------------------------------------
# If inside vim, allow tab switching
bind -n C-Pageup   run "tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys gT"
# For whatever reason, C-Pageup cannot be passed to vim
bind -n C-Pagedown run "tmux display-message -p '#{pane_current_command}' | grep -q '^vim$' && tmux send-keys gt"


#----------------------------------------------------------------------------------------------------------------------
# Looks
#----------------------------------------------------------------------------------------------------------------------
# Contrary to documentation, to be honest, don't see any difference
set -g default-terminal 'screen-256color'

set -g status-interval 20 # update status every 20s

set -g status-justify centre

# remove administrative debris (session name, hostname, time) in status bar
set -g status-left ''
set -g status-right ''

set -g status-right "#[fg=colour130]#([ #{window_panes} -eq 1 ] || echo "")#[fg=colour240]   #{mem_percentage}%   #(WMIC.exe Path Win32_Battery Get EstimatedChargeRemaining | grep '^[0-9]' | sed -e 's/ //g')%   #(date '+%d  #[fg=colour123] %I:%M')"
#set -g status-right " #{mem_percentage}%   #(date '+%m/%d  #[fg=colour123] %I:%M')"
#set -g status-right "#{cpu_fg_color}#{cpu_percentage}  #[fg=colour240] #{mem_percentage}%   #(date '+%m/%d  #[fg=colour123] %I:%M')"

set -g window-status-format '#W '
set -g window-status-current-format '#[fg=colour252,bg=colour0]#W '
set -g window-status-separator ' '

set -g status-position top

set -g status-bg black
set -g status-fg colour240

# set -g pane-border-fg colour235
# set -g pane-active-border-fg colour240
set -g pane-border-fg black
set -g pane-active-border-fg black


#----------------------------------------------------------------------------------------------------------------------
# Plugins and its settings
#----------------------------------------------------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-dir '~/.tmux-resurrect'
# set -g @resurrect-save 'C-t'

set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-boot    'off'     # do not run tmux when computer boots
set -g @continuum-restore 'on'      # restore tmux when opening terminal
set -g @continuum-save-interval '0' # do not save settings

# set -g @plugin 'jbnicolai/tmux-fpp'
# set -g @fpp-key 'f'
set -g @plugin 'Morantron/tmux-fingers'
set -g @fingers-key y # yank

#set -g @plugin 'tmux-plugins/tmux-cpu' # does not use cpu utilization as Windows takes 2s to get one reading and consume a lot of CPU resources
#set -g @cpu_low_fg_color    "#[fg=colour240]"
#set -g @cpu_medium_fg_color "#[fg=colour130]"
#set -g @cpu_high_fg_color   "#[fg=colour196]"

set -g @plugin 'GROG/tmux-plugin-mem'
set -g @mem_high_color      "#[fg=colour196]" # red
set -g @mem_mid_color       "#[fg=colour178]" # light yellow
set -g @mem_low_color       "#[fg=colour240]"
#set -g @mem_high_percentage "75" # default 75%
set -g @mem_mid_percentage "60"

#source-file "${HOME}/.tmux/tmux-themepack/powerline/block/gray.tmuxtheme"

# Keep this line at the very bottom of .tmux.conf
run '~/.tmux/plugins/tpm/tpm'
